<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dygraph with WebSocket</title>
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/dygraphs@2.1.0/dist/dygraph.min.js"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/dygraphs@2.1.0/dist/dygraph.min.css"
    />
    <style>
      #chart {
        width: 100%;
        height: 500px;
      }
    </style>
  </head>
  <body>
    <div id="chart"></div>

    <script type="text/javascript">
      // Initialize the Dygraph with empty data
      const g = new Dygraph(
        document.getElementById("chart"),
        [], // Initial empty dataset
        {
          title: "Real-time Accelerometer Data",
          labels: ["Elapsed Time (s)", "X-axis", "Y-axis", "Z-axis"],
          ylabel: "Acceleration (m/sÂ²)",
          xlabel: "Time (seconds)",
          colors: ["#FF6F61", "#6ABF69", "#6A9FF2"],
          strokeWidth: 2.5,
          drawPoints: true,
          pointSize: 4,
          showRoller: false,
          legend: "always",
        }
      );

      let dataBuffer = [];
      let starttime = 0;

      const socket = new WebSocket(
        "ws://192.168.50.50:8080/sensor/connect?type=android.sensor.accelerometer"
      );

      socket.onopen = function (e) {
        console.log("Connected to the server");
      };

      socket.onerror = function (e) {
        console.log("Error: " + e);
      };

      socket.onmessage = function (event) {
        let message = JSON.parse(event.data);
        let data = message.values; // [x, y, z] values
        let timestamp = message.timestamp;

        if (starttime === 0) {
          starttime = timestamp;
        }

        // Calculate elapsed time in seconds
        let elapsedTime = (timestamp - starttime) / 1000000000;

        // Append the new data to the buffer (x, y, z as columns)
        dataBuffer.push([elapsedTime, data[0], data[1], data[2]]);

        //fuck memory problems, we going RAW
        // Update the Dygraph with the new data
        g.updateOptions({
          file: dataBuffer,
        });
      };
    </script>
  </body>
</html>
